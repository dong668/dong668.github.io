<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>员工端－首页</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

		<link id="phoneCss" rel="stylesheet" type="text/css" href="../css/style.css">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/layer.css" type="text/css" charset="utf-8" />

		<script type="text/javascript" src="../js/jquery-1.11.0.js"></script>
		<script type="text/javascript" src="../js/mui.min.js "></script>
		<script type="text/javascript" src="../utilsJs/constant.js"></script>
		<script type="text/javascript" src="../utilsJs/sha1.js"></script>
		<script type="text/javascript" src="../utilsJs/map.js"></script>
		<script type="text/javascript" src="../utilsJs/httpUtils.js"></script>
		<script type="text/javascript" src="../utilsJs/utils.js"></script>
		<script type="text/javascript" src="../utilsJs/dpHttp.js"></script>
		<script type="text/javascript" src="../utilsJs/layer.js"></script>
		<script type="text/javascript" src="../utilsJs/push.js"></script>
		<script type="text/javascript" src="../utilsJs/showView.js"></script>
		<script type="text/javascript" src="../utilsJs/orderListData.js"></script>

		<script type="text/javascript">
			window.httpUtils = new HttpUtils();
			var ordersArray = new Array();
			var orderTotal = new Array();
			window.constantValues = null;
			window.orderlistData = null;
			var utils = null;
			window.dpHttp = null;
			var orderCount;
			var orderFrom;
			var orderTime;
			var isFlag;

			window.addEventListener('Refresh', function() {
				pulldownRefresh();
			});
			window.addEventListener('PushRefresh', function() {
				if($('#layer_root').length == 0) {
					layerOpen({
						"title": "",
						"content": '订单状态改变了',
						"btn": ["刷新数据"],
						"event": [function() {
							pulldownRefresh();
						}]
					});
				}
			});

			window.addEventListener('logout', function() {
				var main = plus.webview.getWebviewById('main');
				var user = httpUtils.getUserInfo();
				if($('#layer_root').length == 0) {
					layerOpen({
						"title": "",
						"shadeClose": true,
						"content": '退出登录',
						"btn": ["取消", "退出"],
						"event": [null, function() {
							dpHttp.logout(function(responseJson) {
								httpUtils.openIndex();
								main.close();
							}, function(errorJson) {});
						}]
					});
				}
			});

			(function($, doc) {
				$.plusReady(function() {
					var backButtonPress = 0;
					$.back = function(event) {
						backButtonPress++;
						if(backButtonPress > 1) {
							plus.runtime.quit();
						} else {
							ApiConfig.staticShowToast('再按一次退出应用');
						}
						setTimeout(function() {
							backButtonPress = 0;
						}, 1000);
						return false;
					};
				});
			}(mui, document));

			document.documentElement.style.fontSize = document.documentElement.clientWidth / 3.75 + "px";

			if(window.plus) {
				plusReady();
			} else {
				document.addEventListener("plusready", plusReady, false);
			}

			function plusReady() {
				orderlistData = new orderListData();
				utils = new Utils();
				orderCount = ApiConfig.PAGECOUNT;
				orderFrom = 0;
				orderTime = 0;
				constantValues = new ConstantString();
				dpHttp = new DpHttp(utils, httpUtils);
			}
			mui.init({
				pullRefresh: {
					height: 50, //可选,默认50.触发下拉刷新拖动距离,
					container: '#pullrefresh',
					down: {
						callback: pulldownRefresh
					},
					up: {
						height: 50, //可选,默认50.触发下拉刷新拖动距离,
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});

			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				showHide();
				orderTime = 1;
				getOrderInfo(orderFrom, orderCount, true, false, isFlag);
			}
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				showHide();
				if(isFlag) {
					getOrderInfo(orderCount * orderTime, orderCount, false, true, isFlag);
				} else {
					getOrderInfo(orderFrom, orderCount, false, false, isFlag);
					isFlag = true;
				}
			}

			function getOrderInfo(from, count, isDownRefresh, isUpRefresh, flag) {
				var getParams = new Map();
				getParams.put('from', '' + from);
				getParams.put('count', '' + count);
				httpUtils.httpGetAndCheckAccessToken('/adapi/products/orders', getParams,
					function(responseJson) {
						var orderInfos = responseJson.orders;
						var ordersLength = responseJson.orders.length;
						if(flag) {
							if(isDownRefresh) {
								ordersArray = orderInfos;
								orderTotal = [];
								$('.orderStatusCon').parent().children().remove();
								differentiateOrder(true, false, false, true);
							}
							if(isUpRefresh) {
								if(ordersLength > 0) {
									orderTime++;
									ordersArray = orderInfos;
									differentiateOrder(false, true, false, true);
								} else {
									ordersArray.length = 0;
									differentiateOrder(false, true, false, false);
								}
							}
						} else {
							orderTime++;
							ordersArray = orderInfos;
							differentiateOrder(false, false, true, true);
						}
					},
					function(errorJson) {
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
						mui('#pullrefresh').pullRefresh().endPullupToRefresh();
					});
			}

			/**
			 * 
			 * @param {Object} isDownRefresh
			 * @param {Object} isUpRefresh
			 * @param {Object} flag
			 * @param {Object} isMore
			 * 1.一个订单都没有	0
			 * 2.全部当前订单		1
			 * 3.全部是历史订单	2
			 * 4.两个都有的情况	3
			 */
			function differentiateOrder(isDownRefresh, isUpRefresh, flag, isMore) {
				var table = null;
				var orderMap = utils.orderSortByStatus(ordersArray);
				var unfinishedOrder = orderMap.get('unfinishedOrder');
				var finishedOrder = orderMap.get('finishedOrder');
				ApiConfig.staticIsDebug('unfinishedOrder', unfinishedOrder.length);
				ApiConfig.staticIsDebug('finishedOrder', finishedOrder.length);
				for(index in ordersArray) {
					orderTotal.push(ordersArray[index]);
				}

				orderTotal = utils.orderSortByStatusAndReturn(orderTotal);

				ApiConfig.staticIsDebug('orderTotal1', orderTotal.length);

				var orderSortMap = utils.orderSortByStatus(orderTotal);
				var unfinishedSort = orderSortMap.get('unfinishedOrder');
				var finishedSort = orderSortMap.get('finishedOrder');

				if(orderTotal.length == 0) {
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					mui('#pullrefresh').pullRefresh().endPullupToRefresh();
					orderlistData.showAndHie(utils, orderTotal);
					ApiConfig.staticIsDebug(null, '一个订单都没有');
				} else if(unfinishedSort.length > 0 && unfinishedSort.length == 0) {
					showOrderList(unfinishedOrder, isDownRefresh, isUpRefresh, flag, isMore);
					ApiConfig.staticIsDebug(null, '全部当前订单');
				} else if(finishedSort.length > 0 && unfinishedSort.length == 0) {
					showOrderListbie(finishedOrder, isDownRefresh, isUpRefresh, flag, isMore);
					ApiConfig.staticIsDebug(null, '全部是历史订单');
				} else {
					ApiConfig.staticIsDebug(null, '两个都有的情况');
					ApiConfig.staticIsDebug('unfinishedOrder.length', unfinishedOrder.length);
					ApiConfig.staticIsDebug('finishedOrder.length', finishedOrder.length);
					showOrderList(unfinishedOrder, isDownRefresh, isUpRefresh, flag, isMore);

					showOrderListbie(finishedOrder, isDownRefresh, isUpRefresh, flag, isMore);
					ApiConfig.staticIsDebug('orderTotal2', orderTotal.length);
				}
				dpHttp.isUploadLocation(unfinishedOrder);
			}

			function showOrderList(ordersList, isDownRefresh, isUpRefresh, flag, isMore) {
				setTimeout(function() {
					if(flag) {
						mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
					}
					if(isUpRefresh) {
						if(isMore) {
							mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
						} else {
							mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
						}
					}
					var table = document.body.querySelector('#currentorders');
					for(index in ordersList) {
						var order = orderlistData.showOrderListData(ordersList[index], orderTotal, false);
						if(isDownRefresh) {
							table.appendChild(order);
						}
						if(isUpRefresh) {
							table.appendChild(order);
						}
						if(flag) {
							table.appendChild(order);
						}
					}
					if(isDownRefresh) {
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
						mui('#pullrefresh').pullRefresh().refresh(true);
					}
					orderlistData.showAndHie(utils, orderTotal);
				}, 1500);
			}

			function showOrderListbie(ordersList, isDownRefresh, isUpRefresh, flag, isMore) {
				setTimeout(function() {
					if(flag) {
						mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
					}
					if(isUpRefresh) {
						if(isMore) {
							mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
						} else {
							mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
						}
					}
					var table = document.body.querySelector('#historyorders');
					for(index in ordersList) {
						var order = orderlistData.showOrderListData(ordersList[index], orderTotal, true);
						if(isDownRefresh) {
							table.appendChild(order);
						}
						if(isUpRefresh) {
							table.appendChild(order);
						}
						if(flag) {
							table.appendChild(order);
						}
					}
					if(isDownRefresh) {
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
						mui('#pullrefresh').pullRefresh().refresh(true);
					}
					orderlistData.showAndHie(utils, orderTotal);
				}, 1500);
			}

			if(mui.os.plus) {
				mui.plusReady(function() {
					setTimeout(function() {
						showHide();
						utils.orderSortByStatus(orderTotal);
						mui('#pullrefresh').pullRefresh().pullupLoading();
					}, 1000);
				});
			} else {
				mui.ready(function() {
					showHide();
					utils.orderSortByStatus(orderTotal);
					mui('#pullrefresh').pullRefresh().pullupLoading();
				});
			}

			function showHide() {
				$("#noorder").hide();

				$("#nocurrentfont").hide();
				$("#nocurrentimg").hide();

				$("#nohistoryfont").hide();
				$("#nohistoryimg").hide();
			}
		</script>
	</head>

	<body>
		<div id="orderinfo" class="orderStatus1">
			<!--下拉刷新容器-->
			<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
				<div class="mui-scroll">
					<!--数据列表-->
					<div id="nocurrentfont" class="addHistoryOrder mui-table-view" style="display: none;">
						<span class="left" style="margin-top: 0.18rem;"></span> 当前订单
						<span class="right" style="margin-top: 0.18rem;"></span>
					</div>
					<div id="nocurrentimg" class="indexNoOrder mui-table-view " style="display: none; ">
						<div style="margin-top:0.28rem; ">
							<img src="../images/ico_noorder.png " />
						</div>
						<p style="margin-bottom:0.22rem; ">您当前没有订单</p>
					</div>
					<div id="currentorders" class="orders mui-table-view mui-table-view-chevron">
					</div>
					<div id="nohistoryfont" class="addHistoryOrder mui-table-view " style="display: none;  margin-top: 0.08rem;">
						<span class=" left " style="margin-top: 0.18rem; "></span> 历史订单
						<span class="right " style="margin-top: 0.18rem; "></span>
					</div>
					<div id="nohistoryimg" class="indexNoOrder mui-table-view " style="display: none;">
						<div style="margin-top:0.28rem; ">
							<img src="../images/ico_noorder.png " />
						</div>
						<p style="margin-bottom:0.22rem; ">您没有历史订单</p>
					</div>
					<div id="noorder" class="indexNoOrder mui-table-view " style="display: none; ">
						<div>
							<img src="../images/ico_noorder.png " />
						</div>
						<p>您没有订单</p>
					</div>
					<div id="historyorders" class="orders mui-table-view mui-table-view-chevron ">
					</div>
				</div>
			</div>
		</div>
	</body>

</html>