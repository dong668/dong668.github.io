<!DOCTYPE html>
<html>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="HandheldFriendly" content="true" />
	<meta name="MobileOptimized" content="320" />
	<title>Hello H5+</title>
	<script type="text/javascript" src="../js/common.js"></script>
	<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />
	<script type="text/javascript" src="../js/immersed.js"></script>
	<script type="text/javascript" src="../js/sha1.js"></script>
	<script type="text/javascript" src="../js/utils.js"></script>
	<script type="text/javascript">
		var sAliPayUrl = "http://cappdev.mimixiche.cn/capp/trades/alipay_recharge_url?";
		var sWxPayUrl = "http://cappdev.mimixiche.cn/capp/trades/wxpay_recharge?";
		var amount = "";

		function fAliPay() {
			var device_data_id = "c03232b94216385kj5" + phptime();
			var oSignature = new Map();
			oSignature.put("shop_card_id", "566105bfe34b18d3058b45b6");
			oSignature.put("appid", "c03232b94216385kj5");
			oSignature.put("access_token", "UXdKD9c4pd6oylfWU0yU4m57");
			oSignature.put("timestamp", phptime());
			oSignature.put("ver", "4");
			oSignature.put("device_data_id", device_data_id);
			oSignature.put("device_request_id", device_data_id);
			oSignature.put("trade_sum", amount + "");
			var aKeys = oSignature.keys();
			for (var i = 0, len = oSignature.size(); i < len; i++) {
				sAliPayUrl += aKeys[i] + "=" + oSignature.get(aKeys[i]) + "&";
			}
			oSignature.remove("ver");
			oSignature.put("appsecret", "Aqbc8vp0xJVL9dYkdyUgRp60");
			var result = fGetSignature(oSignature);
			sAliPayUrl += "signature=" + result;
		}

		function fWxPay() {
			var device_data_id = "c03232b94216385kj5" + phptime();
			var oSignature = new Map();
			oSignature.put("shop_card_id", "566105bfe34b18d3058b45b6");
			oSignature.put("appid", "c03232b94216385kj5");
			oSignature.put("access_token", "UXdKD9c4pd6oylfWU0yU4m57");
			oSignature.put("timestamp", phptime());
			oSignature.put("ver", "4");
			oSignature.put("device_data_id", device_data_id);
			oSignature.put("device_request_id", device_data_id);
			oSignature.put("trade_sum", amount + "");
			var aKeys = oSignature.keys();
			for (var i = 0, len = oSignature.size(); i < len; i++) {
				sWxPayUrl += aKeys[i] + "=" + oSignature.get(aKeys[i]) + "&";
			}
			oSignature.remove("ver");
			oSignature.put("appsecret", "Aqbc8vp0xJVL9dYkdyUgRp60");
			var result = fGetSignature(oSignature);
			sWxPayUrl += "signature=" + result;
		}
		var pays = {};

		function plusReady() {
			// 获取支付通道
			plus.payment.getChannels(function(channels) {
				var content = document.getElementById('dcontent');
				var txt = "支付通道信息：";
				for (var i in channels) {
					var channel = channels[i];
					pays[channel.id] = channel;
					txt += "id:" + channel.id + ", ";
					txt += "description:" + channel.description + ", ";
					txt += "serviceReady:" + channel.serviceReady + "； ";
					var de = document.createElement('div');
					de.setAttribute('class', 'button');
					de.setAttribute('onclick', 'pay(this.id)');
					de.id = channel.id;
					de.innerText = channel.description + "支付";
					content.appendChild(de);
					checkServices(channel);
				}
			}, function(error) {
				outLine("获取支付通道失败：" + error.message);
			});
		}
		if (window.plus) {
			plusReady();
		} else {
			document.addEventListener("plusready", plusReady, false);
		}

		function checkServices(pc) {
			if (!pc.serviceReady) {
				var txt = null;
				switch (pc.id) {
					case "alipay":
						txt = "检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
						break;
					default:
						txt = "系统未安装“" + pc.description + "”服务，无法完成支付，是否立即安装？";
						break;
				}
				plus.nativeUI.confirm(txt, function(e) {
					if (e.index == 0) {
						pc.installService();
					}
				}, pc.description);
			}
		}
		var w = null;
		// 支付
		function pay(id) {
			if (w) {
				return;
			} //检查是否请求订单中
			amount = document.getElementById('total').value;
			var url = "";
			switch (id) {
				case 'alipay':
					fAliPay();
					url = sAliPayUrl;
					break;
				case 'wxpay':
					fWxPay();
					url = sWxPayUrl;
					break;
			}
			if (id === 'appleiap') {
				outSet("应用内支付");
				clicked('payment_iap.html');
				return;
			}
			outSet("----- 请求支付 -----");
			if (id == 'alipay' || id == 'wxpay') {
				//url += id;
			} else {
				plus.nativeUI.alert("不支持此支付通道！", null, "测试");
				return;
			}
			var appid = plus.runtime.appid;
			if (navigator.userAgent.indexOf('StreamApp') >= 0) {
				appid = 'Stream';
			}
			w = plus.nativeUI.showWaiting();
			// 请求支付订单
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function() {
				switch (xhr.readyState) {
					case 4:
						w.close();
						w = null;
						if (xhr.status == 200) {
							outLine("----- 请求订单成功 -----");
							//outLine(xhr.responseText);
							var order = xhr.responseText;
							outLine(xhr.responseText);
							var order_params = "";
							sOrderjson = eval("(" + xhr.responseText + ")");
							switch (id) {
								case 'alipay':
									var alipay_params = sOrderjson.order_params;
									outLine(alipay_params);
									order_params = alipay_params;
									break;
								case 'wxpay':
									var wxpay_params = JSON.stringify(sOrderjson.order_params);
									wxpay_params = wxpay_params.replace('packages', 'package');
									outLine(wxpay_params);
									order_params = wxpay_params;
									break;
							}
							plus.payment.request(pays[id], order_params, function(result) {
								outLine("----- 支付成功 -----");
								outLine(JSON.stringify(result));
								plus.nativeUI.alert("支付成功", function() {
									back();
								}, "测试");
							}, function(e) {
								outLine("----- 支付失败 -----");
								plus.nativeUI.alert(e.code);
							});
						} else {
							outLine("----- 请求订单失败 -----");
							outLine(xhr.status);
							plus.nativeUI.alert("获取订单信息失败！", null, "测试");
						}
						break;
					default:
						break;
				}
			}
			xhr.open('GET', url);
			outLine("请求支付订单：" + url);
			xhr.send();
		}
	</script>

	<body>
		<header id="header">
			<div class="nvbt iback" onclick="back(true);"></div>
			<div class="nvtt">pay</div>
		</header>
		<div id="dcontent" class="dcontent">
			<p style="padding: 0 1em;text-align:left;"></p>
			<br/>
			<div style="padding: 0 1em;text-align:left">
				金额：<input id="total" type="number" value="3000" style="-webkit-user-select: text;" /> 元
			</div>
			<br/>
		</div>
		<div id="output">
			<paydata></paydata>
		</div>
	</body>

</html>