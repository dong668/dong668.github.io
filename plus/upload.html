<!DOCTYPE html>
<html>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="HandheldFriendly" content="true" />
	<meta name="MobileOptimized" content="320" />
	<title>Hello H5+</title>
	<script type="text/javascript" src="../js/common.js"></script>
	<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />
	<script type="text/javascript" src="../js/immersed.js"></script>
	<script type="text/javascript" src="../js/sha1.js"></script>
	<script type="text/javascript" src="../js/utils.js"></script>
	<script type="text/javascript">
		var sUrlParams = "http://cappdev.mimixiche.cn/capp/basic/upload_image?";
		var sUrl = "http://cappdev.mimixiche.cn/capp/basic/report_opinion?";
		var files = [];
		var sSuccessjson = "";

		function fTest1() {
			//Get
			var oSignature = new Map();
			oSignature.put("appid", "c03232b94216385kj5");
			oSignature.put("access_token", "UXdKD9c4pd6oylfWU0yU4m57");
			oSignature.put("timestamp", phptime());
			oSignature.put("ver", "4");
			var aKeys = oSignature.keys();
			for (var i = 0, len = oSignature.size(); i < len; i++) {
				sUrl += aKeys[i] + "=" + oSignature.get(aKeys[i]) + "&";
			}
			oSignature.remove("ver");
			oSignature.put("appsecret", "Aqbc8vp0xJVL9dYkdyUgRp60");
			var result = fGetSignature(oSignature);
			sUrl += "signature=" + result;
		}

		function report_opinion() {
			fTest1();
			var wt = plus.nativeUI.showWaiting();
			var task = plus.uploader.createUpload(sUrl, {
					method: "POST"
				},
				function(t, status) { //上传完成
					if (status == 200) {
						outLine("上传成功：" + t.responseText);
						wt.close();
					} else {
						outLine("上传失败：" + status);
						wt.close();
					}
				}
			);
			task.addData("image", sSuccessjson.url);
			task.addData("title", "HelloH5+");
			task.addData("content", "HelloH5+");
			task.addData("mobile", "1871035397");
			task.start();
		}

		function fTest() {
			var oSignature = new Map();
			oSignature.put("category", "opinions");
			oSignature.put("appid", "c03232b94216385kj5");
			oSignature.put("access_token", "UXdKD9c4pd6oylfWU0yU4m57");
			oSignature.put("timestamp", phptime());
			oSignature.put("ver", "4");
			var aKeys = oSignature.keys();
			for (var i = 0, len = oSignature.size(); i < len; i++) {
				sUrlParams += aKeys[i] + "=" + oSignature.get(aKeys[i]) + "&";
			}
			oSignature.remove("ver");
			oSignature.put("appsecret", "Aqbc8vp0xJVL9dYkdyUgRp60");
			var result = fGetSignature(oSignature);
			sUrlParams += "signature=" + result;
		}
		// 上传文件
		function upload() {
			if (files.length <= 0) {
				plus.nativeUI.alert("没有添加上传文件！");
				return;
			}
			fTest();
			outSet("开始上传：")
			var wt = plus.nativeUI.showWaiting();
			var task = plus.uploader.createUpload(sUrlParams, {
					method: "POST"
				},
				function(t, status) { //上传完成
					if (status == 200) {
						sSuccessjson = eval("(" + t.responseText + ")");
						outLine("上传成功：" + t.responseText);
						var uploader = sSuccessjson.url;
						plus.storage.setItem("uploader", uploader);
						wt.close();
					} else {
						outLine("上传失败：" + status);
						wt.close();
					}
				}
			);
			task.addData("client", "HelloH5+");
			task.addData("uid", getUid());
			for (var i = 0; i < files.length; i++) {
				var f = files[i];
				task.addFile(f.path, {
					key: "image_file"
				});
			}
			task.start();
		}
		// 拍照添加文件
		function appendByCamera() {
			plus.camera.getCamera().captureImage(function(p) {
				appendFile(p);
			});
		}
		// 从相册添加文件
		function appendByGallery() {
			plus.gallery.pick(function(p) {
				appendFile(p);
			});
		}
		// 添加文件
		var index = 1;

		function appendFile(p) {
			var fe = document.getElementById("files");
			var li = document.createElement("li");
			var n = p.substr(p.lastIndexOf('/') + 1);
			li.innerText = n;
			fe.appendChild(li);
			files.push({
				name: "uploadkey" + index,
				path: p
			});
			index++;
			empty.style.display = "none";
		}
		// 产生一个随机数
		function getUid() {
			return Math.floor(Math.random() * 100000000 + 10000000).toString();
		}
	</script>
	<header id="header">
		<div class="nvbt iback" onclick="back(true);"></div>
		<div class="nvtt">Uploader</div>
		<div class="nvbt idoc" onclick="openDoc('Uploader Document','/doc/uploader.html')"></div>
	</header>
	<div id="dcontent" class="dcontent">
		<br/>
		<p class="heading">上传文件列表：</p>
		<ul id="files" style="text-align:left;">
			<!--<input id="empty" type="text" style="-webkit-user-select: text;font-size:12px;color:#C6C6C6;" placeholder="无上传文件" value="_doc/null/bie/1458875562586.png"/>-->
			<p id="empty" style="font-size:12px;color:#C6C6C6;">无上传文件</p>
		</ul>
		<table style="width:100%;">
			<tbody>
				<tr>
					<td style="width:40%">
						<div class="button button-select" onclick="appendByCamera()">拍照</div>
					</td>
					<td style="width:40%">
						<div class="button button-select" onclick="appendByGallery()">相册选取</div>
					</td>
				</tr>
			</tbody>
		</table>
		<br/>
		<div class="button" onclick="upload()">上 传</div>
		<div class="button" onclick="report_opinion()">上传到测试</div>
		<br/>
	</div>
	<div id="output">
		Uploader Test
	</div>
	</body>

</html>